{% extends 'wagtailbase/base.html' %}
{% load wagtailcore_tags wagtailbase_tags staticfiles compress require %}

{% block meta_title %}{{record.name}}{% endblock %}

{% block extra_head %}
{% compress css %}
<link rel="stylesheet" type="text/x-scss" href="{% static 'vendor/leaflet/dist/leaflet.css' %}">
{% endcompress %}
{% endblock %}

{% block title %}<h1>{{record.name}}</h1>{% endblock %}

{% block main %}
<div class="row">
	<div class="large-6 columns">
		<div class="coordinates">
			<h3><i class="fa fa-map-marker"></i> Coordinates</h3>
            {% for l in record.locus_coordinate.all %}
			<div class="row">
				<div class="large-4 columns">
					<p><strong>Latitude:</strong> {{ l.point.y }}</p>
				</div>
				<div class="large-4 columns">
					<p><strong>Longitude:</strong> {{ l.point.x}}</p>
				</div>
				<div class="large-4 columns">
					<p><strong>Height:</strong> {{ l.height }}</p>
				</div>
			</div>
			<p><strong>Provencance:</strong> {{ l.heritage }}</p>
            {% endfor %}
		</div>

		<div id="map">Here be maps!</div>

        {% if record.pleiades_uri %}
		<h3>Pleiades URI</h3>
		<p><a href="{{ record.pleiades_uri }}" class="ext-links">{{ record.pleiades_uri }}</a></p>
        {% endif %}
        {% if record.geonames_id %}
		<h3>Geonames ID</h3>
        <p><a href="http://www.geonames.org/{{ record.geonames_id }}" class="ext-links">http://www.geonames.org/{{ record.geonames_id }}</a></p>
        {% endif %}        
	</div>
	<div class="large-6 columns">
		<h3>Feature type(s)</h3>
		    {% if request.user.is_authenticated %}
		    <a id="add-feature" data-open="add-feature-modal" class="button">Add feature type</a>

			<div class="reveal" id="add-feature-modal" data-reveal>
				<div id="feature-selections"></div>
			</div>        
            {% endif %}
        {% for f in record.featuretype_fk.all %}
		<p>{{ f.description }}</p>
        {% endfor %}
		<h3>Variant names</h3>
		    {% if request.user.is_authenticated %}
		    <a id="add-variant" data-open="add-variant-modal" class="button">Add variant name</a>

			<div class="reveal" id="add-variant-modal" data-reveal>
				<div id="variant-selections"></div>
			</div>

		    {% endif %}        
		<ol class="long-list">
            {% for v in record.variants.all %}
			<li>{{ v.name }}{% if v.language %} ({{ v.language.en_name }}){% endif %}</li>
            {% endfor %}
		</ol>
		<button class="button secondary show-more">Show more</button>

		<h3>Relationships with other locations <button data-toggle="relationships-dropdown"><i class="fa fa-question-circle"></i></button></h3>
		<div class="dropdown-pane" id="relationships-dropdown" data-dropdown data-auto-focus="true">
			<h4><i class="fa fa-question-circle"></i> Relationships with other locations</h4>
			Provide info to explain how <strong>relationships with other locations</strong> work.
		</div>

		<h4>Related locations <button data-toggle="rel-locations-dropdown"><i class="fa fa-question-circle"></i></button></h4>
		<div class="dropdown-pane" id="rel-locations-dropdown" data-dropdown data-auto-focus="true">
			<h4><i class="fa fa-question-circle"></i> Related locations</h4>
			Provide info to explain how <strong>related locations</strong> work.
		</div>
		    {% if request.user.is_authenticated %}

		    <a id="add-parent" data-open="add-parent-modal" class="button">Add parent location</a>

			<div class="reveal" id="add-parent-modal" data-reveal>
				<div id="parent-selections"></div>
			</div>

		    {% endif %}

		<ul class="long-list">
            {% for r in record.child.all %}
			<li>{{record.name}} <em>{{ r.related_locus_type.name }}</em> <strong><a href="/irt_geo/recordview/?id={{ r.obj.id }}">{{ r.obj.name }}</a></strong></li>
            {% endfor %}
		</ul>
		<button class="button secondary show-more">Show more</button>

		<h4>Inverted related locations <button data-toggle="inverted-rel-locations-dropdown"><i class="fa fa-question-circle"></i></button></h4>
		<div class="dropdown-pane" id="inverted-rel-locations-dropdown" data-dropdown data-auto-focus="true">
			<h4><i class="fa fa-question-circle"></i> Inverted related locations</h4>
			Provide info to explain how <strong>inverted related locations</strong> work.
		</div>

		{% if request.user.is_authenticated %}

	    <a id="add-child" data-open="add-child-modal" class="button">Add child location</a>


		<div class="reveal" id="add-child-modal" data-reveal>
			<div id="child-selections"></div>
		</div>

	    {% endif %}


		<p><em>The locations below form part of</em> <strong>{{ record.name }}</strong></p>
		<ul class="long-list">
            {% for r in record.parent.all %}
            <li><a href="/irt_geo/recordview/?id={{ r.subject.id }}">{{ r.subject.name }}</a></li>            
            {% endfor %}
		</ul>
		<button class="button secondary show-more">Show more</button>

        {% if record.note %}
		<div class="notes">
			<h3><i class="fa fa-edit"></i> Notes</h3>
			<p>{{ record.note }}</p>
		</div>
        {% endif %}
	</div>
</div>
{% endblock %}

{% block extra_footer %}
{% compress js %}
<script src="{% static 'vendor/leaflet/dist/leaflet.js' %}"></script>
<script src="{% static 'vendor/leaflet-draw/dist/leaflet.draw.js' %}"></script>
<script src="{% static 'js/map.js' %}"></script>

{% endcompress %}
<script>
$(document).ready(function(){
	L.Icon.Default.imagePath = "{% static 'vendor/leaflet/dist/images' %}";
    {% for l in record.locus_coordinate.all %}
    {% if forloop.first %}
        var m = L.marker([{{ l.point.y }},{{ l.point.x }}]).addTo(map);
        map.setView([{{ l.point.y }},{{ l.point.x }}],6);
    {% endif %}
    {% endfor %}
    {% if not record.locus_coordinate.all or record.parent.all %}
            // Probably no coordinates, in which case, we can try to draw a convex hull
        $.ajax('/irt_geo/convex-hull/?parent={{ record.id}}',
            {
            success:function(data){
                var hull = new L.geoJson(data).addTo(map);
                map.fitBounds(hull.getBounds());
                map.setZoom( (map.getZoom() - 2 ) );
                }
            }
        )
    {% endif %}

    $("#add-child").on('click',function(){
    	$.ajax('/get/locus-child/{{ record.id }}',{
    		success:function(data){
    			$('#add-child-modal').html(data);
    		}
    	})
    })

    $("#add-parent").on('click',function(){
    	$.ajax('/get/locus-parent/{{ record.id }}',{
    		success:function(data){
    			$('#add-parent-modal').html(data);
    		}
    	})
    })
    
    $("#add-feature").on('click',function(){
    	$.ajax('/get/features/{{ record.id }}',{
    		success:function(data){
    			$('#add-feature-modal').html(data);
    		}
    	})
    })    
    
    $("#add-variant").on('click',function(){
    	$.ajax('/get/variant/{{ record.id }}',{
    		success:function(data){
    			$('#add-variant-modal').html(data);
    		}
    	})
    })     
    
});
</script>
{% endblock %}